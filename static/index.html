<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workflow Engine</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container">
    <h1>Workflow Engine</h1>

    <!-- Submit Workflow -->
    <section>
      <h2>Submit Workflow</h2>
      <div style="margin-bottom:8px;">
        <select id="example-select" onchange="loadExample(this.value)" style="padding:6px 10px; border:1px solid #ccc; border-radius:4px; font-size:0.85rem;">
          <option value="">Load an example...</option>
        </select>
      </div>
      <textarea id="workflow-json" style="min-height:320px;" placeholder="Select an example or paste workflow JSON here..."></textarea>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
        <button id="format-btn" onclick="formatJSON()" style="background:#555;">Format JSON</button>
        <label style="cursor:pointer; font-size:0.85rem; color:#2196F3; margin-left:4px;">
          Upload .json <input type="file" id="file-upload" accept=".json" onchange="uploadFile(event)" style="display:none;">
        </label>
      </div>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:200px; padding:12px; border:1px solid #ddd; border-radius:6px;">
          <button id="submit-btn" onclick="submitWorkflow()" style="width:100%; margin-bottom:6px;">Start Workflow</button>
          <p style="font-size:0.75rem; color:#888; margin:0;">Run steps only. No order created.</p>
        </div>
        <div style="flex:1; min-width:200px; padding:12px; border:1px solid #FF9800; border-radius:6px; background:#fff8f0;">
          <button onclick="startOrderWorkflow()" style="background:#FF9800; width:100%; margin-bottom:6px;">Start with Order</button>
          <p style="font-size:0.75rem; color:#888; margin:0;">Creates an order, then runs the workflow with it attached. Actions like <code>validate_order</code> will update the order status.</p>
        </div>
      </div>
      <div id="submit-error" class="error"></div>
    </section>

    <!-- Runs List -->
    <section>
      <h2>Runs</h2>
      <table>
        <thead>
          <tr>
            <th>Workflow</th>
            <th>Status</th>
            <th>Started</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody id="runs-tbody"></tbody>
      </table>
      <p id="runs-empty" style="color:#888; font-size:0.85rem; display:none;">No runs yet.</p>
    </section>

    <!-- DB Viewer link + Reset -->
    <section style="padding:12px 20px; display:flex; justify-content:center; gap:16px; align-items:center;">
      <a href="/db.html">Live DB Viewer</a>
      <button onclick="resetDB()" style="background:#f44336; font-size:0.8rem; padding:4px 12px;">Reset DB</button>
    </section>
  </div>

<script>
const API = '';

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body !== undefined) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  const data = await res.json();
  if (!res.ok) {
    let msg;
    if (typeof data.detail === 'string') {
      msg = data.detail;
    } else if (Array.isArray(data.detail)) {
      msg = data.detail.map(e => {
        const field = Array.isArray(e.loc) ? e.loc.filter(l => l !== 'body').join(' > ') : '';
        return field ? field + ': ' + e.msg : (e.msg || JSON.stringify(e));
      }).join('; ');
    } else {
      msg = JSON.stringify(data);
    }
    throw new Error(msg);
  }
  return data;
}

// --- JSON auto-fix ---

function tryFixJSON(raw) {
  let s = raw.trim();
  // Replace single quotes with double quotes (but not inside double-quoted strings)
  s = s.replace(/'/g, '"');
  // Remove trailing commas before } or ]
  s = s.replace(/,\s*([}\]])/g, '$1');
  // Quote unquoted keys: word before colon that isn't already quoted
  s = s.replace(/([{,]\s*)([a-zA-Z_]\w*)\s*:/g, '$1"$2":');
  return s;
}

function formatJSON() {
  const ta = document.getElementById('workflow-json');
  const errEl = document.getElementById('submit-error');
  errEl.textContent = '';
  let parsed;
  try {
    parsed = JSON.parse(ta.value);
  } catch (_) {
    try {
      parsed = JSON.parse(tryFixJSON(ta.value));
    } catch (e) {
      errEl.textContent = 'Cannot fix JSON: ' + e.message;
      return;
    }
  }
  ta.value = JSON.stringify(parsed, null, 2);
  errEl.textContent = '';
}

// --- File upload ---

function uploadFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('workflow-json').value = e.target.result;
    formatJSON();
  };
  reader.readAsText(file);
  event.target.value = '';
}

// --- Workflow submission ---

async function submitWorkflow() {
  const errEl = document.getElementById('submit-error');
  const btn = document.getElementById('submit-btn');
  const ta = document.getElementById('workflow-json');
  errEl.textContent = '';

  let json;
  try {
    json = JSON.parse(ta.value);
  } catch (_) {
    // Attempt auto-fix
    try {
      json = JSON.parse(tryFixJSON(ta.value));
      ta.value = JSON.stringify(json, null, 2);
    } catch (e) {
      errEl.textContent = 'Invalid JSON (auto-fix failed): ' + e.message;
      return;
    }
  }

  btn.disabled = true;
  try {
    const wf = await api('POST', '/workflows', json);
    const run = await api('POST', '/workflows/' + wf.id + '/runs');
    window.location.href = '/run.html?id=' + run.id;
  } catch (e) {
    errEl.textContent = e.message;
    btn.disabled = false;
  }
}

// --- Runs list ---

function formatTime(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleTimeString();
}

function duration(startIso, endIso) {
  if (!startIso) return '-';
  const start = new Date(startIso);
  const end = endIso ? new Date(endIso) : new Date();
  const secs = Math.round((end - start) / 1000);
  if (secs < 60) return secs + 's';
  return Math.floor(secs / 60) + 'm ' + (secs % 60) + 's';
}

async function refreshRuns() {
  try {
    const runs = await api('GET', '/runs');
    const tbody = document.getElementById('runs-tbody');
    const empty = document.getElementById('runs-empty');

    if (runs.length === 0) {
      tbody.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    tbody.innerHTML = runs.map(r => `
      <tr class="clickable" onclick="window.location.href='/run.html?id=${r.id}'">
        <td>${esc(r.workflow_name)}</td>
        <td><span class="status status-${r.status}">${r.status}</span></td>
        <td>${formatTime(r.started_at)}</td>
        <td>${duration(r.started_at, r.completed_at)}</td>
      </tr>
    `).join('');
  } catch (e) {
    console.error('Failed to refresh runs:', e);
  }
}

// --- Start with Order (convenience) ---

async function startOrderWorkflow() {
  const errEl = document.getElementById('submit-error');
  const btn = document.getElementById('submit-btn');
  const ta = document.getElementById('workflow-json');
  errEl.textContent = '';

  let json;
  try {
    json = JSON.parse(ta.value);
  } catch (_) {
    try {
      json = JSON.parse(tryFixJSON(ta.value));
      ta.value = JSON.stringify(json, null, 2);
    } catch (e) {
      errEl.textContent = 'Invalid JSON (auto-fix failed): ' + e.message;
      return;
    }
  }

  btn.disabled = true;
  try {
    const order = await api('POST', '/orders', { amount: 49.99 });
    const wf = await api('POST', '/workflows', json);
    const run = await api('POST', '/workflows/' + wf.id + '/runs', { order_id: order.id });
    window.location.href = '/run.html?id=' + run.id;
  } catch (e) {
    errEl.textContent = e.message;
    btn.disabled = false;
  }
}

// --- Helpers ---

function esc(s) {
  const el = document.createElement('span');
  el.textContent = s;
  return el.innerHTML;
}

// --- Examples dropdown ---

async function loadExamples() {
  try {
    const names = await api('GET', '/examples');
    const sel = document.getElementById('example-select');
    for (const name of names) {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name.replace('.json', '');
      sel.appendChild(opt);
    }
  } catch (_) {}
}

async function loadExample(filename) {
  if (!filename) return;
  try {
    const data = await api('GET', '/examples/' + filename);
    document.getElementById('workflow-json').value = JSON.stringify(data, null, 2);
    document.getElementById('submit-error').textContent = '';
  } catch (e) {
    document.getElementById('submit-error').textContent = 'Failed to load example: ' + e.message;
  }
  document.getElementById('example-select').value = '';
}

// --- DB Reset ---

async function resetDB() {
  if (!confirm('Delete all workflows, runs, orders, and results?')) return;
  try {
    await api('POST', '/db/reset');
    refreshRuns();
  } catch (e) {
    alert('Reset failed: ' + e.message);
  }
}

// --- Init ---
loadExamples();
refreshRuns();
setInterval(refreshRuns, 2000);
</script>
</body>
</html>
